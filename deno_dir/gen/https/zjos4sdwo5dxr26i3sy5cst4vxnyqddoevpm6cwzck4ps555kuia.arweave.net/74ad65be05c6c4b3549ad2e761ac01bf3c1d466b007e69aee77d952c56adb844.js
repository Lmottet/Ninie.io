import { formatImageURL } from "../utils/cdn.ts";
import { endpoints } from "../constants/discord.ts";
import { highestRole, higherRolePosition, botHasPermission, } from "../utils/permissions.ts";
import { botID } from "../module/client.ts";
import { Permissions } from "../types/permission.ts";
import { Errors } from "../types/errors.ts";
import { RequestManager } from "../module/requestManager.ts";
import { cache } from "../utils/cache.ts";
import { createChannel } from "../structures/channel.ts";
import { sendMessage } from "./channel.ts";
export function avatarURL(member, size = 128, format) {
    return member.user.avatar
        ? formatImageURL(endpoints.USER_AVATAR(member.user.id, member.user.avatar), size, format)
        : endpoints.USER_DEFAULT_AVATAR(Number(member.user.discriminator) % 5);
}
export function addRole(guildID, memberID, roleID, reason) {
    const botsHighestRole = highestRole(guildID, botID);
    if (botsHighestRole &&
        !higherRolePosition(guildID, botsHighestRole.id, roleID)) {
        throw new Error(Errors.BOTS_HIGHEST_ROLE_TOO_LOW);
    }
    if (!botHasPermission(guildID, [Permissions.MANAGE_ROLES])) {
        throw new Error(Errors.MISSING_MANAGE_ROLES);
    }
    return RequestManager.put(endpoints.GUILD_MEMBER_ROLE(guildID, memberID, roleID), { reason });
}
export function removeRole(guildID, memberID, roleID, reason) {
    const botsHighestRole = highestRole(guildID, botID);
    if (botsHighestRole &&
        !higherRolePosition(guildID, botsHighestRole.id, roleID)) {
        throw new Error(Errors.BOTS_HIGHEST_ROLE_TOO_LOW);
    }
    if (!botHasPermission(guildID, [Permissions.MANAGE_ROLES])) {
        throw new Error(Errors.MISSING_MANAGE_ROLES);
    }
    return RequestManager.delete(endpoints.GUILD_MEMBER_ROLE(guildID, memberID, roleID), { reason });
}
export async function sendDirectMessage(memberID, content) {
    let dmChannel = cache.channels.get(memberID);
    if (!dmChannel) {
        const dmChannelData = await RequestManager.post(endpoints.USER_CREATE_DM, { recipient_id: memberID });
        cache.channels.delete(dmChannelData.id);
        const channel = createChannel(dmChannelData);
        cache.channels.set(memberID, channel);
        dmChannel = channel;
    }
    return sendMessage(dmChannel, content);
}
export function kick(guildID, memberID, reason) {
    const botsHighestRole = highestRole(guildID, botID);
    const membersHighestRole = highestRole(guildID, memberID);
    if (botsHighestRole && membersHighestRole &&
        botsHighestRole.position <= membersHighestRole.position) {
        throw new Error(Errors.BOTS_HIGHEST_ROLE_TOO_LOW);
    }
    if (!botHasPermission(guildID, [Permissions.KICK_MEMBERS])) {
        throw new Error(Errors.MISSING_KICK_MEMBERS);
    }
    return RequestManager.delete(endpoints.GUILD_MEMBER(guildID, memberID), { reason });
}
export function editMember(guildID, memberID, options) {
    if (options.nick) {
        if (options.nick.length > 32) {
            throw new Error(Errors.NICKNAMES_MAX_LENGTH);
        }
        if (!botHasPermission(guildID, [Permissions.MANAGE_NICKNAMES])) {
            throw new Error(Errors.MISSING_MANAGE_NICKNAMES);
        }
    }
    if (options.roles &&
        !botHasPermission(guildID, [Permissions.MANAGE_ROLES])) {
        throw new Error(Errors.MISSING_MANAGE_ROLES);
    }
    if (options.mute) {
        if (!botHasPermission(guildID, [Permissions.MUTE_MEMBERS])) {
            throw new Error(Errors.MISSING_MUTE_MEMBERS);
        }
    }
    if (options.deaf &&
        !botHasPermission(guildID, [Permissions.DEAFEN_MEMBERS])) {
        throw new Error(Errors.MISSING_DEAFEN_MEMBERS);
    }
    return RequestManager.patch(endpoints.GUILD_MEMBER(guildID, memberID), options);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVtYmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibWVtYmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNqRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDcEQsT0FBTyxFQUNMLFdBQVcsRUFDWCxrQkFBa0IsRUFDbEIsZ0JBQWdCLEdBQ2pCLE1BQU0seUJBQXlCLENBQUM7QUFDakMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNyRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDNUMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBRTdELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUMxQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFekQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUczQyxNQUFNLFVBQVUsU0FBUyxDQUN2QixNQUFjLEVBQ2QsT0FBa0IsR0FBRyxFQUNyQixNQUFxQjtJQUVyQixPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTTtRQUN2QixDQUFDLENBQUMsY0FBYyxDQUNkLFNBQVMsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFDekQsSUFBSSxFQUNKLE1BQU0sQ0FDUDtRQUNELENBQUMsQ0FBQyxTQUFTLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDM0UsQ0FBQztBQUdELE1BQU0sVUFBVSxP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